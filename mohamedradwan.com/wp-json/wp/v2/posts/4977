{"id":4977,"date":"2015-08-07T13:23:16","date_gmt":"2015-08-07T13:23:16","guid":{"rendered":"https:\/\/mohamedradwan.com\/?p=4977"},"modified":"2019-07-17T17:44:59","modified_gmt":"2019-07-17T17:44:59","slug":"backup-and-restore-rollback-db-and-web-application-during-tfs-build","status":"publish","type":"post","link":"https:\/\/mohamedradwan.com\/2015\/08\/07\/backup-and-restore-rollback-db-and-web-application-during-tfs-build\/","title":{"rendered":"Backup and Restore (Rollback) DB and Web Application during TFS Build"},"content":{"rendered":"<p>One of our TFS assignments needed to extend the current build and deployment process which includes (<a href=\"https:\/\/mohamedradwan.com\/2015\/01\/26\/creating-and-deploying-web-package-during-tfs-build-2013\/\" target=\"_blank\" rel=\"noopener noreferrer\">Creating and and Deploying Web package<\/a>, <a href=\"https:\/\/mohamedradwan.com\/2014\/11\/06\/deploying-ssdt-during-local-and-server-build\/\" target=\"_blank\" rel=\"noopener noreferrer\">Deploying Database<\/a>, <a href=\"https:\/\/mohamedradwan.com\/2015\/01\/27\/versioning-assembly-during-tfs-build-2013\/\" target=\"_blank\" rel=\"noopener noreferrer\">Versioning Assembly<\/a>, Run Post Integration test after deployment etc.) to include rollback which will perform backup and restore.<\/p>\n<p>We agreed on performing the backup during the deployment and the restore will be a separate build definition.<\/p>\n<p>For the backup during the deployment, I added the following section that backup the DB and the Web App.<a href=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence1.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-large wp-image-4980\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence1.png\" alt=\"Backup DB and Web Squence\" width=\"660\" height=\"386\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence1.png 1339w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence1-300x175.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence1-768x449.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence1-1024x599.png 1024w\" sizes=\"(max-width: 660px) 100vw, 660px\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<h3 class=\"gray\">You can see <strong><a href=\"https:\/\/www.youtube.com\/watch?v=_cdH1XiBNrA\">this video<\/a><\/strong><\/h3>\n<p class=\"gray\">if you would like to find more information about how to restore the old database to the new SQL server by running the command line and TFS Restore tool.<\/p>\n<p>&nbsp;<\/p>\n<h3><strong>Command Text<br \/>\n&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;<br \/>\n<\/strong><span style=\"color: #a31515; font-size: small;\">&#8220;-verb:sync -source:iisapp='&#8221;<\/span><span style=\"font-size: small;\"> + IISApplicationPath + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;&#8216;,computerName=&#8221;<\/span><span style=\"font-size: small;\"> + ServerIP + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;,userName=&#8221;<\/span><span style=\"font-size: small;\"> + IISUserName + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;,password=&#8221;<\/span><span style=\"font-size: small;\"> + IISPassword + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;, -dest:package='&#8221;<\/span><span style=\"font-size: small;\"> + BuildDetail.BuildDefinition.Name + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;_Backup.zip&#8217;,encryptPassword=password123&#8221;<\/span><\/h3>\n<p>The build definition for that part will be as the following:<br \/>\n<a href=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence-parameters.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-large wp-image-4989\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence-parameters.png\" alt=\"Backup DB and Web Squence-parameters\" width=\"660\" height=\"239\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence-parameters.png 1302w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence-parameters-300x109.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence-parameters-768x278.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/backup-db-and-web-squence-parameters-1024x370.png 1024w\" sizes=\"(max-width: 660px) 100vw, 660px\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<p class=\"blue\"><span class=\"ion-tip\">Tip<\/span> If you would like to know more about the best practices for <a href=\"https:\/\/www.visualstudio.com\/team-services\/devops\/\">DevOps<\/a>, Continuous Integration and Continuous Delivery, you can have a look at the following post: <a href=\"https:\/\/mohamedradwan.com\/2017\/12\/29\/develop-vsts-extension-and-configure-ci-continuous-integration-and-cd-continuous-delivery-pipeline\/\">Configure CI (Continuous Integration) and CD (Continuous Delivery Pipeline)<\/a>.<\/p>\n<p>&nbsp;<\/p>\n<p>For the rollback and restore, I added the following section that restore the backup for both DB and Web, for the DB I had to get exclusive access so I can restore the DB even there is active connection from other clients.<\/p>\n<p><a href=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence1.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-large wp-image-4981\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence1.png\" alt=\"Restore DB and Web Squence\" width=\"660\" height=\"338\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence1.png 1308w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence1-300x154.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence1-768x393.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence1-1024x525.png 1024w\" sizes=\"(max-width: 660px) 100vw, 660px\" \/><\/a><\/p>\n<p><strong>Command Text<br \/>\n&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;<br \/>\n<\/strong><span style=\"color: #a31515; font-size: small;\">&#8220;cmd.exe \/k Sqlcmd -Q &#8220;&#8221;use master alter database &#8220;<\/span><span style=\"font-size: small;\"> + DBNameForBackup + <\/span><span style=\"color: #a31515; font-size: small;\">&#8221; set single_user with rollback immediate RESTORE DATABASE &#8220;<\/span><span style=\"font-size: small;\"> + DBNameForBackup + <\/span><span style=\"color: #a31515; font-size: small;\">&#8221; FROM DISK='&#8221;<\/span><span style=\"font-size: small;\"> + DBNameForBackup + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;_Bakup.bak&#8217; WITH REPLACE alter database &#8220;<\/span><span style=\"font-size: small;\"> + DBNameForBackup + <\/span><span style=\"color: #a31515; font-size: small;\">&#8221; set multi_user&#8221;&#8221; -S &#8220;<\/span><span style=\"font-size: small;\"> + DBServerOrIP<\/span><\/p>\n<p><strong>Command Text<br \/>\n&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;<br \/>\n<\/strong><span style=\"color: #a31515; font-size: small;\">&#8220;-verb:sync -source:package=&#8221;&#8221;C:WindowsSysWOW64&#8221;<\/span><span style=\"font-size: small;\"> + BuildDefinitionDeploymentName + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;_Backup.zip&#8221;&#8221; -dest:iisapp='&#8221;<\/span><span style=\"font-size: small;\"> + IISApplicationPath + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;&#8216;,computerName=&#8221;<\/span><span style=\"font-size: small;\"> + ServerIP + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;,userName=&#8221;<\/span><span style=\"font-size: small;\"> + IISUserName + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;,password=&#8221;<\/span><span style=\"font-size: small;\"> + IISPassword + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;, -setParam:kind=ProviderPath,scope=iisApp,value='&#8221;<\/span><span style=\"font-size: small;\"> + IISApplicationPath + <\/span><span style=\"color: #a31515; font-size: small;\">&#8220;&#8216;&#8221;<\/span><\/p>\n<p>&nbsp;<\/p>\n<h3 class=\"gray\">You can see <strong><a href=\"https:\/\/www.youtube.com\/watch?v=YXOr7OoLNUU\">this video<\/a><\/strong><\/h3>\n<p class=\"gray\">if you would like to find more information about how to open the SQL Server Reporting Services Configuration Manager on the new Data Base tier (which is the application tier) and change the Database to the restored Data Base, how to restore the SSRS Encryption Key, how to solve the issue with the Deployment pointing on two servers using the RSKeyMngmt and RSKeyMngmt &#8211; r commands in the Command Prompt.<\/p>\n<p>&nbsp;<\/p>\n<p>The build definition for that part will be as the following:<br \/>\n<a href=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence-parameters.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-large wp-image-4990\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence-parameters.png\" alt=\"Restore DB and Web Squence-parameters\" width=\"660\" height=\"252\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence-parameters.png 1180w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence-parameters-300x114.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence-parameters-768x293.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2015\/08\/restore-db-and-web-squence-parameters-1024x391.png 1024w\" sizes=\"(max-width: 660px) 100vw, 660px\" \/><\/a><\/p>\n<h2>Some good commands that I end up with:<\/h2>\n<h3>PowerShell<br \/>\n==========<\/h3>\n<p>sqlps (PowerShell for SQL)<\/p>\n<p>PS SQLSERVER:&gt; Backup-SqlDatabase -ServerInstance . -Database database1 -BackupAction Database<\/p>\n<p>PS SQLSERVER:&gt; Backup-SqlDatabase -ServerInstance 10.43.94.222 -Database database1 -BackupAction Database<\/p>\n<p>PS SQLSERVER:&gt; Invoke-Sqlcmd -Query &#8220;BACKUP DATABASE DATABASE1 TO DISK=&#8217;BackupsMyDB.bak'&#8221; -ServerInstance 10.43.94.222 -U\u00a0YourUserName -P YourPassword<\/p>\n<p>PS SQLSERVER:&gt; Invoke-Sqlcmd -Query &#8220;RESTORE DATABASE DATABASE1 FROM DISK=&#8217;BackupsMyDB.bak&#8217; WITH REPLACE&#8221; -ServerInstance 10.43.94.222 -U\u00a0YourUserName -P YourPassword<\/p>\n<p>PS SQLSERVER:&gt; Invoke-Sqlcmd -Query &#8220;use master alter database database1 set single_user with rollback immediate alter database database1 set multi_user&#8221; -ServerInstance 10.43.94.222 -U\u00a0YourUserName -P YourPassword<\/p>\n<p>PS SQLSERVER:&gt; Invoke-Sqlcmd -Query &#8220;use master alter database database1 set single_user with rollback immediate RESTORE DATABASE DATABASE1 FROM DISK=&#8217;BackupsMyDB.bak&#8217; WITH REPLACE alter database database1 set multi_user&#8221; -ServerInstance 10.43.94.222 -U\u00a0YourUserName -P YourPassword<\/p>\n<p>&nbsp;<\/p>\n<p class=\"green\"><span class=\"ion-info\">More Info<\/span>If you would like to learn more about using the <a href=\"https:\/\/docs.microsoft.com\/en-us\/vsts\/build-release\/concepts\/definitions\/build\/variables?tabs=batch\">Build Variables<\/a> in <a href=\"https:\/\/www.visualstudio.com\/team-services\/\">VSTS<\/a> and Release Management, &#8211; have a look at the following post: <a href=\"https:\/\/mohamedradwan.com\/2018\/03\/11\/vsts-build-variables-and-echo\/\">VSTS Build variables and Echo<\/a>. The post describes how to see the output at any point of time, while automating a process, through setting variables and displaying them during the build.<\/p>\n<p>&nbsp;<\/p>\n<h3>sqlcmd<br \/>\n=======<\/h3>\n<p>sqlcmd -U\u00a0YourUserName -P YourPassword -S 10.43.94.222<\/p>\n<p>Sqlcmd -Q &#8220;BACKUP DATABASE DATABASE1 TO DISK=&#8217;BackupsMyDB.bak'&#8221; -S 10.43.94.222 -U\u00a0YourUserName -P YourPassword<\/p>\n<p>Sqlcmd -Q &#8220;use master alter database database1 set single_user with rollback immediate RESTORE DATABASE DATABASE1 FROM DISK=&#8217;BackupsMyDB.bak&#8217; WITH REPLACE alter database database1 set multi_user&#8221; -S 10.43.94.222 -U\u00a0YourUserName -P YourPassword<\/p>\n<h2>Delete DB Backup T-SQL<br \/>\n=========================<\/h2>\n<p>EXECUTE master.dbo.xp_delete_file 0,N&#8217;G:Microsoft SQL ServerMSSQL11.BGAPIDB01QMSSQLBackup&#8217;,N&#8217;BAK&#8217;<\/p>\n<h3>Invoke Process by call .bat file<br \/>\n===========================<\/h3>\n<p>BuildDirectory + &#8220;srcScriptsBackDB_Test.bat&#8221;<\/p>\n<h3>Invoke Process by cmd.exe and arguments<br \/>\n=======================================<\/h3>\n<p>File: \u00a0\u00a0&#8220;cmd.exe&#8221;<br \/>\nArguemnts: \u00a0&#8220;cmd.exe \/k Sqlcmd -Q &#8220;&#8221;BACKUP DATABASE DATABASE1 TO DISK=&#8217;BackupsMyDB.bak'&#8221;&#8221; -S 10.43.94.189 -U YourUserName-P YourPassword&#8221;<\/p>\n<p>===================================================================================================================================================================================<\/p>\n<p>&nbsp;<\/p>\n<h3 class=\"gray\">You can see <strong><a href=\"https:\/\/www.youtube.com\/watch?v=dtcdfilQar8\">this video<\/a><\/strong><\/h3>\n<p class=\"gray\">If you would like to find more information about how to use the cliconfig command in the Command Prompt in the elevated mode to enable the TCP\/IP and create a new alias in the SQL Server Client Network Utility, how to use the get-spdatabase in the SharePoint Management Shell and how to map each database with the correct ID using the db-ChangeDatabaseInstance method.<\/p>\n<p>&nbsp;<\/p>\n<h3>Web<br \/>\n=====<\/h3>\n<p>msdeploy -verb:sync -source:iisapp=&#8217;Default web site\/Lara&#8217;,computerName=Localhost -dest:package=&#8217;defaultWebsiteBackup.zip&#8217;,encryptPassword=password123<\/p>\n<p>msdeploy -verb:sync -source:iisapp=&#8217;Default web site\/Lara&#8217;,computerName=172.18.0.333,userName=YourUserName,password=YourPassword, -dest:package=&#8217;defaultWebsiteBackup.zip&#8217;,encryptPassword=password123<br \/>\nmsdeploy -verb:sync -source:package=&#8221;C:Program Files (x86)IISMicrosoft Web Deploy V3defaultWebsiteBackup.zip&#8221; -dest:auto -setParam:kind=ProviderPath,scope=iisApp,value=&#8217;Default web site\/Lara&#8217;<\/p>\n<p>msdeploy -verb:sync -source:package=&#8221;C:WindowsSysWOW64defaultWebsiteBackup.zip&#8221; -dest:iisapp=&#8217;Default web site\/Lara&#8217;,computerName=172.18.0.333,userName=YourUserName,password=YourPassword, -setParam:kind=ProviderPath,scope=iisApp,value=&#8217;Default web site\/Lara&#8217;<\/p>\n<p>&nbsp;<\/p>\n<p class=\"blue\"><span class=\"ion-tip\">Tip<\/span> Read about basic guidelines that you need to consider when building a <strong>product backlog<\/strong> in the following post, <a href=\"https:\/\/mohamedradwan.com\/2017\/12\/05\/requirements-epic-feature-user-story-task-size-and-estimation-in-agile-and-scrum\/\">Requirements (Epic, Feature, User Story), Task Size and Estimation in Agile and Scrum<\/a>, and also about its maintaining and refinement of product backlog in <a href=\"https:\/\/mohamedradwan.com\/2017\/11\/30\/key-tips-for-maintaining-good-product-backlog-in-agile-and-scrum\/\">Key tips for Maintaining good product backlog in Agile and Scrum<\/a>.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>One of our TFS assignments needed to extend the current &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"ast-button\" href=\"https:\/\/mohamedradwan.com\/2015\/08\/07\/backup-and-restore-rollback-db-and-web-application-during-tfs-build\/\"> <span class=\"screen-reader-text\">Backup and Restore (Rollback) DB and Web Application during TFS Build<\/span> Read More<\/a><\/p>\n","protected":false},"author":1,"featured_media":5491,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-global-header-display":"","ast-banner-title-visibility":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","footnotes":""},"categories":[16,17,29,38,43],"tags":[],"_links":{"self":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/4977"}],"collection":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/comments?post=4977"}],"version-history":[{"count":5,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/4977\/revisions"}],"predecessor-version":[{"id":9598,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/4977\/revisions\/9598"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/media\/5491"}],"wp:attachment":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/media?parent=4977"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/categories?post=4977"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/tags?post=4977"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}