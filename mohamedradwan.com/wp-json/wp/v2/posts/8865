{"id":8865,"date":"2019-01-18T01:56:15","date_gmt":"2019-01-18T01:56:15","guid":{"rendered":"https:\/\/mohamedradwan.com\/?p=8865"},"modified":"2019-07-10T16:06:27","modified_gmt":"2019-07-10T16:06:27","slug":"auto-scaling-with-virtual-node-and-azure-kubernetes-service","status":"publish","type":"post","link":"https:\/\/mohamedradwan.com\/2019\/01\/18\/auto-scaling-with-virtual-node-and-azure-kubernetes-service\/","title":{"rendered":"Auto scaling with virtual node and Azure Kubernetes Service"},"content":{"rendered":"<p>.<a href=\"#_Toc500069570\">Introduction<\/a><br \/>\n<a href=\"#_Toc500069571\">Background of Azure container instances<\/a><br \/>\n<a href=\"#_Toc500069572\"> Going through an open source project \u2013 Virtual Kubelet<\/a><br \/>\n<a href=\"#_Toc500069573\"> Virtual Node in public preview<\/a><br \/>\n<a href=\"#_Toc500069574\">Conclusion<\/a><\/p>\n<h2><a name=\"_Toc500069570\"><\/a>Introduction<\/h2>\n<p>In this post we are going to talk about how to auto scale with AKS and a new public preview feature called Virtual Node. Virtual node is now a public preview feature with <a href=\"https:\/\/azure.microsoft.com\/en-gb\/services\/kubernetes-service\/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Kubernetes Service<\/a>. With virtual node you can burst into Azure Container Instances where you have no VM management. This enables you to scale your <a href=\"https:\/\/kubernetes.io\/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes <\/a>clusters even faster when you combine concepts like the horizontal pod autoscaler. The technology behind this is virtual kubelet which is an open source project supported by multiple cloud providers.<\/p>\n<h2><a name=\"_Toc500069571\"><\/a>Background of Azure container instances<\/h2>\n<p>Sometimes, all you need to do is just run a container. VMs just take up too management for just trying to run a single workload and that is why we need Azure Container Instances. They takes away of VM management, it starts in seconds and it support Windows and Linux. It is also a hyper-v isolated, which means that you have a same level of isolation that you get in VMs today just at the container level. You can also configure the amount of memory and CPU that you want.<\/p>\n<h2><a name=\"_Toc500069572\"><\/a>Going through an open source project \u2013 Virtual Kubelet<\/h2>\n<p>Virtual Kubulet is able to connect the Kuburnetes APIs to any other kind of service. For Azure it is connecting with outer container instances, but there is also another provider for the IOT edge. There is also a support for the rest of the community. Not only Microsoft but also providers from Amazon, Hyper SH, VMware. With CI and Virtual Kubulet and AKS is build a preview called Virtual Node. In the image 1 is shown the architecture of Virtual Node in AKS.<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_8866\" aria-describedby=\"caption-attachment-8866\" style=\"width: 979px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-8866\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-1-Virtual-node-architecture-in-AKS.png\" alt=\"Image 1 - Virtual node architecture in AKS\" width=\"979\" height=\"772\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-1-Virtual-node-architecture-in-AKS.png 979w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-1-Virtual-node-architecture-in-AKS-300x237.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-1-Virtual-node-architecture-in-AKS-768x606.png 768w\" sizes=\"(max-width: 979px) 100vw, 979px\" \/><figcaption id=\"caption-attachment-8866\" class=\"wp-caption-text\">Image 1 &#8211; Virtual node architecture in AKS<\/figcaption><\/figure>\n<p>You get the management of a chaos and the masters are already controlled for you because it is a managed control plane. But you also get an extra burst capacity through a CI and Virtual Node. Now you can have one to X amount of VMs in your cluster and then you can install Virtual Node in order to be able to scale out (basically infinitely) into a CI. And there is no VMs to think about. When you are scaling you don\u2019t have to scale VMs and then think about the workloads that go on top of them. But all you do is scale out Azure container instances and you don\u2019t realize it because the management plan is still Kubernetes.<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<p class=\"green\"><span class=\"ion-info\">More Info<\/span>If you would like to learn more about what is the story behind containers and what drives or the needs for it, we will know why companies moved from traditional solution architecture to Microservices and how this put containers as the perfect solution for running them, we will get quick intro to clear some definitions, tools and keywords related to this ecosystem.<\/p>\n<p class=\"green\">For example, we will understand what is the different between VM. Container and Hyper-V Container, why we would prefer container over VM and when the VM is better. We will understand the different between container and image and know the life cycle of creating a new image and why I do that. Like adding more layers to the base image, push that to container images registry on the cloud. Then pull that from the registry to anywhere to have a new container. We will understand also different technologies and services around container. like Docker, Docker Swarm, Kubernetes, Azure Container Services (ACS), Azure Container Registry, etc.- have a look at this post &#8211; have a look at the <a href=\"https:\/\/mohamedradwan.com\/2018\/04\/17\/containers-the-perfect-solution-for-running-microservices\/\"><strong>this post<\/strong><\/a><\/p>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc500069573\"><\/a>Virtual Node in public preview<\/h2>\n<p>Let us see it in practice. I have already installed a Virtual Node in my cluster. And I have went ahead and installed an entire application. Which is a simple front-end that simulates a Black Friday event (selling service books, X-boxes). In other words it is just a simple website. I started a big amount of load with load tester which is paying the front-end a lot in order to see how our cluster scales would that demand with the customer traffic. Now we are going to head over to application insights which have live metrics stream. Where we can see the amount of incoming requests. How long the requests are actually during it for. And also the amount of servers that are coming up to (image 2).<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_8867\" aria-describedby=\"caption-attachment-8867\" style=\"width: 1372px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-8867\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-2-Live-metrics-stream.png\" alt=\"Image 2 - Live metrics stream\" width=\"1372\" height=\"774\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-2-Live-metrics-stream.png 1372w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-2-Live-metrics-stream-300x169.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-2-Live-metrics-stream-768x433.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-2-Live-metrics-stream-1024x578.png 1024w\" sizes=\"(max-width: 1372px) 100vw, 1372px\" \/><figcaption id=\"caption-attachment-8867\" class=\"wp-caption-text\">Image 2 &#8211; Live metrics stream<\/figcaption><\/figure>\n<p>In addition, we are going to use another dashboard, Grafana which is an open-source dashboarding tool. We can see that the RPS (request per second) and RPS per pod are going exponentially up. But on the other side the response time is actually going down because we are getting a bunch of more infrastructure starting up (image 3).<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_8868\" aria-describedby=\"caption-attachment-8868\" style=\"width: 1372px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-8868\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-3-Grafana.png\" alt=\"Image 3 - Grafana\" width=\"1372\" height=\"774\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-3-Grafana.png 1372w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-3-Grafana-300x169.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-3-Grafana-768x433.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-3-Grafana-1024x578.png 1024w\" sizes=\"(max-width: 1372px) 100vw, 1372px\" \/><figcaption id=\"caption-attachment-8868\" class=\"wp-caption-text\">Image 3 &#8211; Grafana<\/figcaption><\/figure>\n<p>If we open the Azure Cloud Shell (image 4). We can see the amount of containers that are pending. This is where the Kubernetes is stepping in and helping to auto scale out. We are using the horizontal pot on a scaler which is an unknown thing in Kubernetes. That allows you to horizontally scale out your pods.<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_8869\" aria-describedby=\"caption-attachment-8869\" style=\"width: 1372px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-8869\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-4-Azure-Cloud-Shell-pending-containers.png\" alt=\"Image 4 - Azure Cloud Shell - pending containers\" width=\"1372\" height=\"774\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-4-Azure-Cloud-Shell-pending-containers.png 1372w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-4-Azure-Cloud-Shell-pending-containers-300x169.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-4-Azure-Cloud-Shell-pending-containers-768x433.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-4-Azure-Cloud-Shell-pending-containers-1024x578.png 1024w\" sizes=\"(max-width: 1372px) 100vw, 1372px\" \/><figcaption id=\"caption-attachment-8869\" class=\"wp-caption-text\">Image 4 &#8211; Azure Cloud Shell &#8211; pending containers<\/figcaption><\/figure>\n<p>If we go back to the Live Metrics stream and refresh the page, we can see all of the container instances that are actually spinning up in the same resource group, and also we can note that we have so many of them that started up within a couple of seconds (image 5).<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_8870\" aria-describedby=\"caption-attachment-8870\" style=\"width: 1372px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-8870\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-5-Container-instances-spinning-up-in-the-same-resource-group.png\" alt=\"Image 5 - Container instances spinning up in the same resource group\" width=\"1372\" height=\"774\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-5-Container-instances-spinning-up-in-the-same-resource-group.png 1372w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-5-Container-instances-spinning-up-in-the-same-resource-group-300x169.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-5-Container-instances-spinning-up-in-the-same-resource-group-768x433.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2019\/01\/Image-5-Container-instances-spinning-up-in-the-same-resource-group-1024x578.png 1024w\" sizes=\"(max-width: 1372px) 100vw, 1372px\" \/><figcaption id=\"caption-attachment-8870\" class=\"wp-caption-text\">Image 5 &#8211; Container instances spinning up in the same resource group<\/figcaption><\/figure>\n<p>For this amount of containers, you will probably need 5 to 10 VMs, all starting up one after another, but in our case we just have 20 or 30 pots started up in tandem.<\/p>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc500069574\"><\/a>Conclusion<\/h2>\n<p>You can use Virtual Nodes to auto scale out from your cluster into a CI. Giving you an easy solution for scaling in Kubernetes. Virtual Nodes allows AKS users to make use of the compute capacity of Azure Container- Instances (ACI) to fire up additional containers rather than having to bring up Virtual Machine (VM)-based nodes. It is, Microsoft said, a simple act of flipping a switch to get access to all that resource.<\/p>\n<p>&nbsp;<\/p>\n<p class=\"gray\"><span class=\"ion-video\">Video<\/span> You can see <strong><a href=\"https:\/\/www.youtube.com\/watch?v=uGAcWLnSU0A\">this video<\/a><\/strong>, if you would like to find more information about how to get started with Release Management and its advantages. See how to create a build definition using CI\/CD Tools for VSTS Extensions (I will be using Package Extension and Publish Artifact tasks). And also using DevOps-VSTS-POC trigger in order to enable CI. All of that in order to be able to publish, share, install and query versions. You will see how to create release definition. Choose an artifact and configure source for the artifact and default version. See how to create different environments or clone the existing one, in my case I am going to create QA. Preproduction and Production environment, each with one phrase and one task. See also how to configure Publish Extension task for each environment See an end-to-end continuous delivery pipeline using VSTS extension with Build and Release Management.<\/p>\n<p>&nbsp;<\/p>\n","protected":false},"excerpt":{"rendered":"<p>.Introduction Background of Azure container instances Going through an open &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"ast-button\" href=\"https:\/\/mohamedradwan.com\/2019\/01\/18\/auto-scaling-with-virtual-node-and-azure-kubernetes-service\/\"> <span class=\"screen-reader-text\">Auto scaling with virtual node and Azure Kubernetes Service<\/span> Read More<\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-global-header-display":"","ast-banner-title-visibility":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","footnotes":""},"categories":[18],"tags":[949,948,947],"_links":{"self":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/8865"}],"collection":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/comments?post=8865"}],"version-history":[{"count":5,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/8865\/revisions"}],"predecessor-version":[{"id":9450,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/8865\/revisions\/9450"}],"wp:attachment":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/media?parent=8865"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/categories?post=8865"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/tags?post=8865"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}