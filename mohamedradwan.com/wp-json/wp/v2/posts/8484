{"id":8484,"date":"2018-04-28T16:42:53","date_gmt":"2018-04-28T16:42:53","guid":{"rendered":"https:\/\/mohamedradwan.com\/?p=8484"},"modified":"2019-07-17T08:55:03","modified_gmt":"2019-07-17T08:55:03","slug":"automatically-creating-staging-environment-for-dynamics-365-on-the-cloud","status":"publish","type":"post","link":"https:\/\/mohamedradwan.com\/2018\/04\/28\/automatically-creating-staging-environment-for-dynamics-365-on-the-cloud\/","title":{"rendered":"Automatically Creating Staging Environment for Dynamics 365 on The Cloud"},"content":{"rendered":"<p>t<\/p>\n<ol>\n<li><a href=\"#_Toc512444188\">Introduction<\/a><\/li>\n<li><a href=\"#_Toc512444189\"> Prepare client machine and the source of the Image<\/a><\/li>\n<li><a href=\"#_Toc512444190\"> Upload the VHD<\/a><\/li>\n<li><a href=\"#_Toc512444191\"> Create Image from VHD<\/a><\/li>\n<li><a href=\"#_Toc512444192\"> Create VM from Image<\/a><\/li>\n<li><a href=\"#_Toc512444193\"> Run join domain Script\u00a0<\/a><\/li>\n<li><a href=\"#_Toc512444194\"> Registry file to update CRM registry with the new server name<\/a><\/li>\n<li><a href=\"#_Toc512444195\">PowerShell script to execute SQL scripts to update values with new server name<\/a><\/li>\n<li><a href=\"#_Toc512444196\"> Change the SSRS to map to the old DB on the new machine and restore SSRS encryption key<\/a><\/li>\n<li><a href=\"#_Toc512444197\"> Fix App pools credentials<\/a><\/li>\n<li><a href=\"#_Toc512444198\"> Change the CRM Web Address settings<\/a><\/li>\n<\/ol>\n<p>&nbsp;<\/p>\n<h2>1.\u00a0\u00a0\u00a0\u00a0 Introduction<\/h2>\n<p>Having or creating a new Dynamics 365 environment very quickly and in a reliable way is crucial for the business, it&#8217;s needed for different scenarios for example, if you want to test new feature immediately, and you have many testers, you want to provide a separate environment for each one where it has the new solutions where the tester can verify the completed features before approve and merge that with the master branch with other accepted or verified features, or if your end user needs to evaluate the new module being developed, or if you want to run some automation testing on an environment without interrupting the current tester&#8217;s environment, there are many scenarios where we will need to have that environment, created, has Dynamics 365 installed, has all CRM solutions, deployed all developed features and ready in no time and with less effort, so how to do that?<\/p>\n<p>&nbsp;<\/p>\n<h3>The answer is always very simple, by <strong>Automation<\/strong>.<\/h3>\n<p>&nbsp;<\/p>\n<p>In the post and video, I am not going to show all the whole process as it\u2019s not completed yet but I will show big part of it and I will continue later.<\/p>\n<p>&nbsp;<\/p>\n<p>So we will see how to create new Dynamics 365 CRM environment locally with Windows Server 2016 Standard Edition, then prepare this machine to be ready to upload to the cloud (Azure), then upload the machine to Azure, then create image of that machine, after that, we will start using this image for creating new virtual machine with Dynamics 365 then reconfigure the machine to fix all the problems because changing the hard disk and the machine name which will make problem for SSRS (SQL Server Reporting Server), all IIS application pools crashed, the SQL Server name crashed, and of course Dynamics 365 CRM doesn\u2019t work, so I will show exactly how to solve all those problems so we can have a new copy of an existing Dynamics CRM machine and make it works fine.<\/p>\n<p>&nbsp;<\/p>\n<p><strong>The following image is describing the process steps:<\/strong><\/p>\n<figure id=\"attachment_8672\" aria-describedby=\"caption-attachment-8672\" style=\"width: 760px\" class=\"wp-caption alignnone\"><a href=\"https:\/\/mohamedradwan.com\/2018\/04\/28\/automatically-creating-staging-environment-for-dynamics-365-on-the-cloud\/automatically-creating-staging-environment-for-dynamics-workflow\/\" rel=\"attachment wp-att-8672\"><img loading=\"lazy\" decoding=\"async\" class=\"size-large wp-image-8672\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Automatically-Creating-Staging-Environment-for-Dynamics-workflow-1024x503.png\" alt=\"Automatically Creating Staging Environment for Dynamics workflow\" width=\"760\" height=\"373\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Automatically-Creating-Staging-Environment-for-Dynamics-workflow-1024x503.png 1024w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Automatically-Creating-Staging-Environment-for-Dynamics-workflow-300x147.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Automatically-Creating-Staging-Environment-for-Dynamics-workflow-768x377.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Automatically-Creating-Staging-Environment-for-Dynamics-workflow.png 1471w\" sizes=\"(max-width: 760px) 100vw, 760px\" \/><\/a><figcaption id=\"caption-attachment-8672\" class=\"wp-caption-text\">Automatically Creating Staging Environment for Dynamics workflow<\/figcaption><\/figure>\n<p>&nbsp;<\/p>\n<p>The following video describes the current post in action, in case anyone prefers videos, also the video and the post could be helpful for anyone wants to change CRM database name on live CRM system, or wants to rename CRM server.<\/p>\n<div style=\"text-algn:left\"><span style=\"display:inline-block;text-align:center;\"><iframe allow=\"autoplay\" class=\"youtube_embed_iframe\"    allowFullScreen=\"true\" style=\"width:640px; height:385px\" src=\"https:\/\/www.youtube.com\/embed\/4JbZcTmSNzs?autoplay=0&theme=dark&loop=0&fs=1&showinfo=1&modestbranding=0&iv_load_policy=1&color=red&autohide=1&disablekb=0&enablejsapi=1&version=3\"><\/iframe><\/span><\/div>\n<h2><a name=\"_Toc512444189\"><\/a>2.\u00a0\u00a0\u00a0\u00a0 Prepare client machine and the source of the Image<\/h2>\n<ul>\n<li>Install <strong>MS Azure Storage Explorer<\/strong> on the client machine (my PC)<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/azure.microsoft.com\/en-us\/features\/storage-explorer\/\">https:\/\/azure.microsoft.com\/en-us\/features\/storage-explorer\/<\/a><\/p>\n<p>&nbsp;<\/p>\n<ul>\n<li>Install <strong>Azure Copy<\/strong> on the client machine (my PC)<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/docs.microsoft.com\/en-us\/azure\/storage\/common\/storage-use-azcopy\">https:\/\/docs.microsoft.com\/en-us\/azure\/storage\/common\/storage-use-azcopy<\/a><\/p>\n<p>&nbsp;<\/p>\n<ul>\n<li>Create new local VM<\/li>\n<\/ul>\n<ul>\n<li>Convert VHDX to VHD and Fixed Size to be ready for Azure<\/li>\n<\/ul>\n<ul>\n<li>Install Windows Server 2016 on VM<\/li>\n<\/ul>\n<ul>\n<li>Join Domain (VM)<\/li>\n<\/ul>\n<ul>\n<li>Install CRM and updates (VM)<\/li>\n<\/ul>\n<ul>\n<li>Install the latest Azure PowerShell on both machine, the VM and the client machine (my PC) in that date, it was (Azure PowerShell 5.7.0) so we can run our commands to Azure.<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/github.com\/Azure\/azure-powershell\/releases\/tag\/v5.7.0-April2018\">https:\/\/github.com\/Azure\/azure-powershell\/releases\/tag\/v5.7.0-April2018<\/a><\/p>\n<p>&nbsp;<\/p>\n<ul>\n<li>Install SSRS PowerShell on (VM)<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true\">Install-Module -Name ReportingServicesTools<\/pre>\n<p>&nbsp;<\/p>\n<ul>\n<li>Run some PowerShell Scripts to confirm the preparation of the machine, like enable remote desktop, firewall and many others (VM)<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/docs.microsoft.com\/en-us\/azure\/virtual-machines\/windows\/prepare-for-upload-vhd-image\">https:\/\/docs.microsoft.com\/en-us\/azure\/virtual-machines\/windows\/prepare-for-upload-vhd-image<\/a><\/p>\n<p>&nbsp;<\/p>\n<ul>\n<li>Generalize the machine using Systprep (VM)<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><strong>%windir%\\system32\\sysprep<\/strong><\/p>\n<p>&nbsp;<\/p>\n<p class=\"blue\"><span class=\"ion-tip\">Tip<\/span> If you would like to learn more about Microsoft Dynamics development, including the overview of the Microsoft Dynamics CRM itself, installing Microsoft Dynamics 2016 on Azure VM and how to upgrade to Dynamics 365, how to develop Dynamics CRM plugin, how to debug Microsoft Dynamics CRM project, create and run unit tests using FakeXRMEasy and Microsoft Fakes, JavaScript and front end unit tests as well code quality using JSHint, also how to create and run UI and how to integrate all the practices as part of the CI\/CD (Continuous Integration and Continuous Delivery), &#8211; have a look at the <a href=\"https:\/\/mohamedradwan.com\/2018\/04\/04\/devops-for-microsoft-dynamics\/\"><strong>this post<\/strong><\/a><\/p>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444190\"><\/a>3.\u00a0\u00a0\u00a0\u00a0 Upload the VHD<\/h2>\n<ul>\n<li>Create new Resource Group to hold VHDs and Images<\/li>\n<\/ul>\n<ul>\n<li>Make Storage Account using Azure Portal<\/li>\n<\/ul>\n<ul>\n<li>Generate Blob Containers inside the Storage Account using Azure Storage Explorer to upload VHDs<\/li>\n<\/ul>\n<ul>\n<li>Generate <strong>Shared Access Signature (SAS)<\/strong>\u00a0for the target Blob Container using Azure Storage Explorer (UI)<\/li>\n<\/ul>\n<ul>\n<li>Upload the new VHD using Azure Copy or Azure Storage Explorer (UI) as <strong>Page blob<\/strong>, remember page blob is not the default.<\/li>\n<\/ul>\n<ul>\n<li>The following is how to upload using Azure Copy after generate SAS from Azure Storage Explorer with enough date:<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/docs.microsoft.com\/en-us\/azure\/storage\/common\/storage-use-azcopy\">https:\/\/docs.microsoft.com\/en-us\/azure\/storage\/common\/storage-use-azcopy<\/a><\/p>\n<p>&nbsp;<\/p>\n<pre class=\"wrap:true lang:default decode:true\">AzCopy \/Source:\"C:\\VMs\\CRM\\Virtual Hard Disks\\CRMFromOnPrem.vhd\" \/Dest:https:\/\/myvmsimages.blob.core.windows.net\/uploaded-vms\/CRMFromOnPrem.vhd \/DestSAS:\"?st=2018-03-13T17%3A11%3A00Z&amp;xxxxxxxxx\" \/BlobType:page<\/pre>\n<p>&nbsp;<\/p>\n<ul>\n<li>Or upload using Azure Storage Explorer (UI)<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444191\"><\/a>4.\u00a0\u00a0\u00a0\u00a0 Create Image from VHD<\/h2>\n<ul>\n<li>Run PowerShell as Admin and connect to Azure using the following command (my PC)<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true \">Add-AzureRmAccount<\/pre>\n<p>&nbsp;<\/p>\n<ul>\n<li>Create image from uploaded VHD in the target RG with the following command (my PC)<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/docs.microsoft.com\/en-us\/azure\/virtual-machines\/windows\/capture-image-resource\">https:\/\/docs.microsoft.com\/en-us\/azure\/virtual-machines\/windows\/capture-image-resource<\/a><\/p>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true\">$rgName = \"Radwan\"\r\n\r\n$location = \"westeurope\"\r\n\r\n$imageName = \"CRMImage\"\r\n\r\n$osVhdUri = \"https:\/\/myvmsimages.blob.core.windows.net\/uploaded-vms\/CRMConverted.vhd\"\r\n\r\n$imageConfig = New-AzureRmImageConfig -Location $location\r\n\r\n$imageConfig = Set-AzureRmImageOsDisk -Image $imageConfig -OsType Windows -OsState Generalized -BlobUri $osVhdUri\r\n\r\n$image = New-AzureRmImage -ImageName $imageName -ResourceGroupName $rgName -Image $imageConfig<\/pre>\n<p>&nbsp;<\/p>\n<p><strong>We can also create image from Azure Portal for new VMs by click capture, see the following image:<\/strong><\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_8674\" aria-describedby=\"caption-attachment-8674\" style=\"width: 760px\" class=\"wp-caption alignnone\"><a href=\"https:\/\/mohamedradwan.com\/2018\/04\/28\/automatically-creating-staging-environment-for-dynamics-365-on-the-cloud\/create-image-from-vm-on-azure-then-create-vm-from-that-image\/\" rel=\"attachment wp-att-8674\"><img loading=\"lazy\" decoding=\"async\" class=\"size-large wp-image-8674\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-Image-from-VM-on-Azure-then-create-VM-from-that-image-1024x522.jpg\" alt=\"Create Image from VM on Azure then create VM from that image\" width=\"760\" height=\"387\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-Image-from-VM-on-Azure-then-create-VM-from-that-image-1024x522.jpg 1024w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-Image-from-VM-on-Azure-then-create-VM-from-that-image-300x153.jpg 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-Image-from-VM-on-Azure-then-create-VM-from-that-image-768x391.jpg 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-Image-from-VM-on-Azure-then-create-VM-from-that-image.jpg 1309w\" sizes=\"(max-width: 760px) 100vw, 760px\" \/><\/a><figcaption id=\"caption-attachment-8674\" class=\"wp-caption-text\">Create Image from VM on Azure then create VM from that image<\/figcaption><\/figure>\n<p>Remember, we <span style=\"text-decoration: underline;\"><strong>must<\/strong> <\/span>generalize the VM or the VHD &#8220;<strong>sysprep<\/strong>&#8221; before creating an image no matter what the way we create the image, otherwise, the VM from that image will not work properly.<\/p>\n<p><strong>We can also create snapshot from VM disk and then create a new VM from that snapshot, see the following image:<\/strong><\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_8675\" aria-describedby=\"caption-attachment-8675\" style=\"width: 760px\" class=\"wp-caption alignnone\"><a href=\"https:\/\/mohamedradwan.com\/2018\/04\/28\/automatically-creating-staging-environment-for-dynamics-365-on-the-cloud\/create-snapshot-from-azure-disk-then-create-managed-disk-then-create-vm-from-managed-disk\/\" rel=\"attachment wp-att-8675\"><img loading=\"lazy\" decoding=\"async\" class=\"size-large wp-image-8675\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-snapshot-from-Azure-Disk-then-create-Managed-Disk-then-create-VM-from-Managed-disk-1024x447.jpg\" alt=\"Create snapshot from Azure Disk then create Managed Disk then create VM from Managed disk\" width=\"760\" height=\"332\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-snapshot-from-Azure-Disk-then-create-Managed-Disk-then-create-VM-from-Managed-disk-1024x447.jpg 1024w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-snapshot-from-Azure-Disk-then-create-Managed-Disk-then-create-VM-from-Managed-disk-300x131.jpg 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-snapshot-from-Azure-Disk-then-create-Managed-Disk-then-create-VM-from-Managed-disk-768x335.jpg 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Create-snapshot-from-Azure-Disk-then-create-Managed-Disk-then-create-VM-from-Managed-disk.jpg 1689w\" sizes=\"(max-width: 760px) 100vw, 760px\" \/><\/a><figcaption id=\"caption-attachment-8675\" class=\"wp-caption-text\">Create snapshot from Azure Disk then create Managed Disk then create VM from Managed disk<\/figcaption><\/figure>\n<p><strong>The following image shows the icon of each type in Azure Portal:<\/strong><\/p>\n<figure id=\"attachment_8673\" aria-describedby=\"caption-attachment-8673\" style=\"width: 1008px\" class=\"wp-caption alignnone\"><a href=\"https:\/\/mohamedradwan.com\/2018\/04\/28\/automatically-creating-staging-environment-for-dynamics-365-on-the-cloud\/azure-icons-for-snapshot-disk-image\/\" rel=\"attachment wp-att-8673\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-8673\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Azure-icons-for-Snapshot-Disk-Image.png\" alt=\"Azure icons for Snapshot - Disk - Image\" width=\"1008\" height=\"205\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Azure-icons-for-Snapshot-Disk-Image.png 1008w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Azure-icons-for-Snapshot-Disk-Image-300x61.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2018\/04\/Azure-icons-for-Snapshot-Disk-Image-768x156.png 768w\" sizes=\"(max-width: 1008px) 100vw, 1008px\" \/><\/a><figcaption id=\"caption-attachment-8673\" class=\"wp-caption-text\">Azure icons for Snapshot &#8211; Disk &#8211; Image<\/figcaption><\/figure>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444192\"><\/a>5.\u00a0\u00a0\u00a0\u00a0 Create VM from Image<\/h2>\n<ul>\n<li>Click on the image then click create VM (Azure Portal)<\/li>\n<\/ul>\n<ul>\n<li>Or create VM from image using PowerShell (will be added later)<\/li>\n<\/ul>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/docs.microsoft.com\/en-us\/azure\/virtual-machines\/windows\/create-vm-generalized-managed\">https:\/\/docs.microsoft.com\/en-us\/azure\/virtual-machines\/windows\/create-vm-generalized-managed<\/a><\/p>\n<h2><a name=\"_Toc512444193\"><\/a><\/h2>\n<h2><a name=\"_Toc512444193\"><\/a>6.\u00a0\u00a0\u00a0\u00a0 Run to join domain Script<\/h2>\n<ul>\n<li>After the machine created, remote login to the machine and run the join domain script<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true\">$domain = \"myDomain.co.uk\"\r\n\r\n$password = \"myAccountPassword\" | ConvertTo-SecureString -asPlainText -Force\r\n\r\n$username = \"myDomain\\myAccount\"\r\n\r\n$credential = New-Object System.Management.Automation.PSCredential($username,$password)\r\n\r\nAdd-Computer -DomainName $domain -Credential $credential\r\n\r\nRestart-Computer<\/pre>\n<p>If the Azure V-Net not configure in the way that makes the VM to see the domain, I mean the DNS is not configured, I can manually configure the DNS to point to the AD so the VM can see and the domain and be able to join.<\/p>\n<pre class=\"lang:default decode:true\">$wmi = Get-WmiObject win32_networkadapterconfiguration -filter \"ipenabled = 'true'\"\r\n$wmi.SetDNSServerSearchOrder(\"10.1.0.4\")<\/pre>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444194\"><\/a>7.\u00a0\u00a0\u00a0\u00a0 Run Registry file to update CRM registry with the new server name<\/h2>\n<ul>\n<li>Change the reg file with the new server name and run it<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true \">Windows Registry Editor Version 5.00\r\n\r\n\r\n\r\n[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\MSCRM]\r\n\r\n\"configdb\"=\"Data Source=My_New_CRM_Server_Name;Initial Catalog=MSCRM_CONFIG;Integrated Security=SSPI\"\r\n\r\n\"ServerUrl\"=\"http:\/\/My_New_CRM_Server_Name\/MSCRMServices\"<\/pre>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444195\"><\/a>8.\u00a0\u00a0\u00a0\u00a0 Run PowerShell script to execute SQL scripts to update values with new server name<\/h2>\n<ul>\n<li>Open the two scripts and put the new server name and run the PowerShell Script as admin<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true\">Invoke-Sqlcmd -InputFile \"C:\\Partial Autoamtion\\3-Update DB with new CRM Server name (CRM).sql\"\r\n\r\n\r\n\r\nInvoke-Sqlcmd -InputFile \"C:\\Partial Autoamtion\\4-Update DB with new CRM Server name (SQL).sql\"<\/pre>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<p>Script 1<\/p>\n<pre class=\"lang:default decode:true \">DECLARE  @NewCRMServerName nvarchar(300)\r\n\r\nSET @NewCRMServerName='oooradwanooo'\r\n\r\nuse [MSCRM_CONFIG]\r\n\r\n\r\n\r\nUPDATE\r\n\r\nDeploymentProperties\r\n\r\nSET\r\n\r\n[NVarCharColumn] = @NewCRMServerName+':80' where [ColumnName]='ADDeploymentSdkRootDomain'\r\n\r\n\r\n\r\nUPDATE\r\n\r\nServer\r\n\r\nSET\r\n\r\n[FullName] =@NewCRMServerName +'.workspacegroup.co.uk' where [Fullname]='WIN-IAOJRE3CRCP.workspacegroup.co.uk'\r\n\r\n\r\n\r\nUPDATE\r\n\r\nConfigSettings\r\n\r\nSET\r\n\r\n[HelpServerUrl] = 'http:\/\/'+ @NewCRMServerName +':5555\/'\r\n\r\n\r\n\r\nUPDATE\r\n\r\nOrganization\r\n\r\nSET\r\n\r\n[ConnectionString] = 'Provider=SQLOLEDB;Data Source='+ @NewCRMServerName +';Initial Catalog=Demo_MSCRM;Integrated Security=SSPI',\r\n\r\n[SqlServerName] = @NewCRMServerName,\r\n\r\n[SrsUrl] = 'http:\/\/'+ @NewCRMServerName +'\/reportserver'\r\n\r\n\r\n\r\nUPDATE\r\n\r\n[Server]\r\n\r\nSET [Name] = @NewCRMServerName\r\n\r\nGo<\/pre>\n<p>&nbsp;<\/p>\n<p>Script 2<\/p>\n<pre class=\"lang:default decode:true \">SP_DROPSERVER \"WIN-IAOJRE3CRCP\"\r\n\r\nGo\r\n\r\n\r\n\r\nSP_ADDSERVER \"My_New_CRM_Server_Name\", local<\/pre>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444196\"><\/a>9.\u00a0\u00a0\u00a0\u00a0 Change the SSRS to map to the old DB on the new machine and restore SSRS encryption key<\/h2>\n<ul>\n<li>Open the script and put the new server name and run the PowerShell Script as admin<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true\">Set-RsDatabase -DatabaseServerName my_New_Machine_Name -Name my_DB_Name -IsExistingDatabase\u00a0 -DatabaseCredentialType ServiceAccount -Confirm:$false\r\n\r\n\r\n\r\nRestore-RSEncryptionKey -Password 'My_SSRS_EncryptionKey_Password' -KeyPath 'C:\\Partial Autoamtion\\CRMSRSReportKey.snk'<\/pre>\n<p>&nbsp;<\/p>\n<p class=\"blue\"><span class=\"ion-tip\">Tip<\/span> If you would like to learn more about how to work with SSRS PowerShell so we can remap SSRS or SQL Sever Reporting Server Database to an existing DB, we will see also how to restore SSRS encryption key &#8211; have a look at this post- have a look at the <a href=\" https:\/\/mohamedradwan.com\/2018\/04\/23\/working-with-ssrs-sql-server-reporting-server-powershell\/\"><strong>this post<\/strong><\/a><\/p>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444197\"><\/a>10. Fix App pools credentials<\/h2>\n<ul>\n<li>Run the following PowerShell script as admin reenter the credential after creating the new machine<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true \">Import-Module WebAdministration\r\n\r\n\r\n\r\n\r\n\r\nSet-ItemProperty IIS:\\AppPools\\CRMAppPool -name processModel -value @{userName=\"my_Domain\\my_ServiceAccount\";password=\"my_ServicePassword\";identitytype=3}\r\n\r\n\r\n\r\n\r\n\r\nSet-ItemProperty IIS:\\AppPools\\CrmDeploymentServiceAppPool -name processModel -value @{userName=\"my_Domain\\my_ServiceAcccount\";password=\"my_ServicePassword\";identitytype=3}\r\n\r\n\r\n\r\nStart-WebAppPool -Name \"CRMAppPool\"\r\n\r\n\r\n\r\nStart-WebAppPool -Name \"CrmDeploymentServiceAppPool\"<\/pre>\n<p>&nbsp;<\/p>\n<p class=\"green\"><span class=\"ion-info\">More Info<\/span> If you would like to learn more about how to change the credential of IIS Application Pool using PowerShell, we will also use PowerShell to restart the Application Pool &#8211; have a look at this post &#8211; have a look at the <a href=\"https:\/\/mohamedradwan.com\/2018\/04\/23\/working-with-iis-powershell\/\"><strong>this post<\/strong><\/a><\/p>\n<p>&nbsp;<\/p>\n<h2><a name=\"_Toc512444198\"><\/a>11. Change the CRM Web Address settings<\/h2>\n<ul>\n<li>Open the script and put the new server name and run the PowerShell Script as admin<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<pre class=\"lang:default decode:true\">param\r\n\r\n(\r\n\r\n#optional params\r\n\r\n[string]$RootDomainScheme,\r\n\r\n[string]$DeploymentSdkRootDomain,\r\n\r\n[string]$DiscoveryRootDomain,\r\n\r\n[boolean]$NlbEnabled,\r\n\r\n[string]$SdkRootDomain,\r\n\r\n[string]$SslHeader,\r\n\r\n[string]$WebAppRootDomain,\r\n\r\n[string]$NewCRMMachineName\r\n\r\n)\r\n\r\n\r\n\r\n#$DeploymentSdkRootDomain=\"my_New_Machine_Name:80\"\r\n\r\n$NewCRMMachineName=\"My_New_Machine_Name:80\"\r\n\r\n$DiscoveryRootDomain=$NewCRMMachineName\r\n\r\n$SdkRootDomain=$NewCRMMachineName\r\n\r\n$WebAppRootDomain=$NewCRMMachineName\r\n\r\n\r\n\r\n$RemoveSnapInWhenDone = $False\r\n\r\n\r\n\r\nif (-not (Get-PSSnapin -Name Microsoft.Crm.PowerShell -ErrorAction SilentlyContinue))\r\n\r\n{\r\n\r\nAdd-PSSnapin Microsoft.Crm.PowerShell\r\n\r\n$RemoveSnapInWhenDone = $True\r\n\r\n}\r\n\r\n\r\n\r\n$WebAddressSettings = Get-CrmSetting -SettingType WebAddressSettings\r\n\r\n\r\n\r\n#if($DeploymentSdkRootDomain) {$WebAddressSettings.DeploymentSdkRootDomain = $DeploymentSdkRootDomain}\r\n\r\nif($DiscoveryRootDomain) {$WebAddressSettings.DiscoveryRootDomain = $DiscoveryRootDomain}\r\n\r\nif($PSBoundParameters.ContainsKey('NlbEnabled')) {$WebAddressSettings.NlbEnabled = $NlbEnabled}\r\n\r\nif($RootDomainScheme) {$WebAddressSettings.RootDomainScheme = $RootDomainScheme}\r\n\r\nif($SdkRootDomain) {$WebAddressSettings.SdkRootDomain = $SdkRootDomain}\r\n\r\nif($PSBoundParameters.ContainsKey('SslHeader')) {$WebAddressSettings.SslHeader = $SslHeader}\r\n\r\nif($WebAppRootDomain) {$WebAddressSettings.WebAppRootDomain = $WebAppRootDomain}\r\n\r\n\r\n\r\nSet-CrmSetting -Setting $WebAddressSettings\r\n\r\n\r\n\r\n$WebAddressSettings\r\n\r\n\r\n\r\nif($RemoveSnapInWhenDone)\r\n\r\n{\r\n\r\nRemove-PSSnapin Microsoft.Crm.PowerShell\r\n\r\n}\r\n\r\nRestart-Computer<\/pre>\n<p>&nbsp;<\/p>\n<p style=\"padding-left: 30px;\"><a href=\"https:\/\/technet.microsoft.com\/en-us\/library\/gg985381.aspx\">https:\/\/technet.microsoft.com\/en-us\/library\/gg985381.aspx<\/a><\/p>\n<p>&nbsp;<\/p>\n<p class=\"blue\"><span class=\"ion-tip\">Tip<\/span> If you would like to learn more about how to use PowerShell to change some values for Microsoft Dynamics 365 &#8211; have a look at this post &#8211; have a look at the <a href=\" https:\/\/mohamedradwan.com\/2018\/04\/23\/working-with-microsoft-dynamics-365-powershell\/ \"><strong>this post<\/strong><\/a><\/p>\n<p>&nbsp;<\/p>\n<p class=\"green\"><span class=\"ion-info\">More Info<\/span>If, after adding a new user to <a href=\"https:\/\/dynamics.microsoft.com\/en-gb\/\">Dynamics 365<\/a>, you get the following error: <em>You do not have permissions to see this view. Contact a system administrator crm, &#8211; <\/em>, &#8211; have a look at the <a href=\"https:\/\/mohamedradwan.com\/2018\/03\/07\/fix-you-do-not-have-permissions-to-see-this-view-contact-a-system-administrator-crm\/\"><strong>this post<\/strong><\/a><\/p>\n<p>&nbsp;<\/p>\n<p>In many cases we might need to create progress bar if we copy many files or searching for many files and we can use the following command to do that.<br \/>\n<a href=\"https:\/\/docs.microsoft.com\/en-us\/powershell\/module\/microsoft.powershell.utility\/write-progress?view=powershell-6\" target=\"_blank\" rel=\"noopener noreferrer\">https:\/\/docs.microsoft.com\/en-us\/powershell\/module\/microsoft.powershell.utility\/write-progress?view=powershell-6<\/a><\/p>\n<pre class=\"lang:default decode:true \">for ($I = 1; $I -le 100; $I++ )\r\n{Write-Progress -Activity \"Search in Progress\" -Status \"$I% Complete:\" -PercentComplete $I;}<\/pre>\n<p>I may add sleep for the loop so I can see or simulate the slow progress<\/p>\n<pre class=\"lang:default decode:true \">for ($I = 1; $I -le 100; $I++ )\r\n{Write-Progress -Activity \"Search in Progress\" -Status \"$I% Complete:\" -PercentComplete $I;\r\nsleep 1;\r\n}<\/pre>\n<p>&nbsp;<\/p>\n<h3>Remember to use\u00a0 ConvertTo-SecureString cmdlet to converts encrypted standard strings into secure strings<\/h3>\n<p><a href=\"https:\/\/docs.microsoft.com\/en-us\/powershell\/module\/microsoft.powershell.security\/convertto-securestring?view=powershell-6\" target=\"_blank\" rel=\"noopener noreferrer\">https:\/\/docs.microsoft.com\/en-us\/powershell\/module\/microsoft.powershell.security\/convertto-securestring?view=powershell-6<\/a><\/p>\n<pre class=\"lang:default decode:true \">$Secure = Read-Host -AsSecureString\r\n$Secure\r\nSystem.Security.SecureString\r\n$Encrypted = ConvertFrom-SecureString -SecureString $Secure\r\n$Encrypted\r\n01000000d08c9ddf0115d1118c7a00c04fc297eb010000001a114d45b8dd3f4aa11ad7c0abdae9800000000002000000000003660000a8000000100000005df63cea84bfb7d70bd6842e7\r\nefa79820000000004800000a000000010000000f10cd0f4a99a8d5814d94e0687d7430b100000008bf11f1960158405b2779613e9352c6d14000000e6b7bf46a9d485ff211b9b2a2df3bd\r\n6eb67aae41\r\n$Secure2 = ConvertTo-SecureString -String $Encrypted\r\n$Secure2\r\nSystem.Security.SecureString<\/pre>\n<h3><\/h3>\n<h3>Write-Host<\/h3>\n<p><a href=\"https:\/\/docs.microsoft.com\/en-us\/powershell\/module\/microsoft.powershell.utility\/write-host?view=powershell-6\" target=\"_blank\" rel=\"noopener noreferrer\">https:\/\/docs.microsoft.com\/en-us\/powershell\/module\/microsoft.powershell.utility\/write-host?view=powershell-6<\/a><\/p>\n<h2>PowerShell with VSTS<\/h2>\n<p><a href=\"https:\/\/docs.microsoft.com\/en-us\/vsts\/pipelines\/tasks\/utility\/powershell?view=vsts#arguments\" target=\"_blank\" rel=\"noopener noreferrer\">https:\/\/docs.microsoft.com\/en-us\/vsts\/pipelines\/tasks\/utility\/powershell?view=vsts#arguments<\/a><\/p>\n","protected":false},"excerpt":{"rendered":"<p>t Introduction Prepare client machine and the source of the &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"ast-button\" href=\"https:\/\/mohamedradwan.com\/2018\/04\/28\/automatically-creating-staging-environment-for-dynamics-365-on-the-cloud\/\"> <span class=\"screen-reader-text\">Automatically Creating Staging Environment for Dynamics 365 on The Cloud<\/span> Read More<\/a><\/p>\n","protected":false},"author":1,"featured_media":8508,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-global-header-display":"","ast-banner-title-visibility":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","footnotes":""},"categories":[16,18,23,893,922],"tags":[934,933,894,895,935,936],"_links":{"self":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/8484"}],"collection":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/comments?post=8484"}],"version-history":[{"count":5,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/8484\/revisions"}],"predecessor-version":[{"id":9570,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/8484\/revisions\/9570"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/media\/8508"}],"wp:attachment":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/media?parent=8484"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/categories?post=8484"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/tags?post=8484"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}