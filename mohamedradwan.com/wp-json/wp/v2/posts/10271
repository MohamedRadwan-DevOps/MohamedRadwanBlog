{"id":10271,"date":"2021-09-27T23:46:13","date_gmt":"2021-09-27T23:46:13","guid":{"rendered":"https:\/\/mohamedradwan.com\/?p=10271"},"modified":"2021-09-30T12:32:01","modified_gmt":"2021-09-30T12:32:01","slug":"preventing-resource-deletion-in-azure","status":"publish","type":"post","link":"https:\/\/mohamedradwan.com\/2021\/09\/27\/preventing-resource-deletion-in-azure\/","title":{"rendered":"Preventing Resource Deletion in Azure"},"content":{"rendered":"<p>When we build Azure resources, it doesn\u2019t mean that someone is not going to go in and delete it for us, or we also might accidentally delete something important just because we forgot that we weren\u2019t supposed to. Even if we are a <a href=\"https:\/\/mohamedradwan.com\/2019\/06\/06\/devops-tutorial-for-beginners-developing-ci-cd-pipelines-continuous-integration-and-deployment\/\">DevOps<\/a> person or an Ops person, we may have sometimes the right to do it because sometimes we need to delete production resources, but we just want to prevent it to do by accident.<\/p>\n<p>&nbsp;<\/p>\n<p>For cases like this, there is a great tool within an Azure which is called Locks, which locks some resources in order to prevent any modification or deletion.<\/p>\n<p>&nbsp;<\/p>\n<p>This post explains this new feature, preventing deleting production resources by accident. If we are deploying in a production environment, we may probably want to have some locks. Usually, we should generate some locks on every resource deploy in the production environment. It&#8217;s up to us to take our templates or generate the templates and adapt with our use case and constraint, but in both cases, the logs are automatically generated in a production environment.<\/p>\n<p>&nbsp;<\/p>\n<p>In order to check our locks (if there are any), we should go in our Azure Portal, open our Resource group and navigate to the locks.<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_10274\" aria-describedby=\"caption-attachment-10274\" style=\"width: 1514px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-10274\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-1-Example-Lock-on-resource.png\" alt=\"\" width=\"1514\" height=\"752\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-1-Example-Lock-on-resource.png 1514w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-1-Example-Lock-on-resource-300x149.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-1-Example-Lock-on-resource-1024x509.png 1024w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-1-Example-Lock-on-resource-768x381.png 768w\" sizes=\"(max-width: 1514px) 100vw, 1514px\" \/><figcaption id=\"caption-attachment-10274\" class=\"wp-caption-text\">Image 1 &#8211; Example Lock on resource<\/figcaption><\/figure>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<p>Here we can see all existing locks for the current resource group. Also, here we can Delete or edit the locks.<\/p>\n<p>&nbsp;<\/p>\n<p>The new thing in <a href=\"https:\/\/www.nubesgen.com\/\">NubesGen<\/a> is adding support for the Bicep tool. With this, a lock module is generated for any resource group, creating a resource which is a lock to which we assign people to have the right to remove the lock itself.<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_10272\" aria-describedby=\"caption-attachment-10272\" style=\"width: 1802px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-10272\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-2-doNotDelete-lock-and-roleAssignment.png\" alt=\"\" width=\"1802\" height=\"904\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-2-doNotDelete-lock-and-roleAssignment.png 1802w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-2-doNotDelete-lock-and-roleAssignment-300x150.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-2-doNotDelete-lock-and-roleAssignment-1024x514.png 1024w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-2-doNotDelete-lock-and-roleAssignment-768x385.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-2-doNotDelete-lock-and-roleAssignment-1536x771.png 1536w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-2-doNotDelete-lock-and-roleAssignment-600x300.png 600w\" sizes=\"(max-width: 1802px) 100vw, 1802px\" \/><figcaption id=\"caption-attachment-10272\" class=\"wp-caption-text\">\u00cfmage 2 &#8211; doNotDelete lock and roleAssignment<\/figcaption><\/figure>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<p>So we are doing two things here automatically. We are creating this \u201cdo not delete\u201d lock, and we are assigning a role to some principle ID. So basically, to some user or to some service principle, we pass some parameters to do this. And we already leveraging here a cool feature of Bicep, which is conditions, which means that with spacing IF, meaning if this condition is met, then Bicep will actually deploy this lock. But if not, this code will not get deployed by Bicep or by Azure CLI.<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<figure id=\"attachment_10273\" aria-describedby=\"caption-attachment-10273\" style=\"width: 1442px\" class=\"wp-caption alignnone\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-10273\" src=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-3-Condition-for-deploying-the-lock.png\" alt=\"\" width=\"1442\" height=\"723\" srcset=\"https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-3-Condition-for-deploying-the-lock.png 1442w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-3-Condition-for-deploying-the-lock-300x150.png 300w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-3-Condition-for-deploying-the-lock-1024x513.png 1024w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-3-Condition-for-deploying-the-lock-768x385.png 768w, https:\/\/mohamedradwan.com\/wp-content\/uploads\/2021\/09\/Image-3-Condition-for-deploying-the-lock-600x300.png 600w\" sizes=\"(max-width: 1442px) 100vw, 1442px\" \/><figcaption id=\"caption-attachment-10273\" class=\"wp-caption-text\">Image 3 &#8211; Condition for deploying the lock<\/figcaption><\/figure>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<p>So here is a cool thing to actually deploy locks only on the production environment. But obviously, we can reuse the feature to do a lot of different conditions in our infrastructure code.<\/p>\n<p>&nbsp;<\/p>\n<p>This gives us a lot of flexibility to say yes, we can lock down production. Maybe there are resource groups or other things that are very particular that we can&#8217;t delete. And we all have worked on customer projects where we have almost a hub or an area that cannot be deleted because we can&#8217;t repeat that code.<\/p>\n<p>&nbsp;<\/p>\n<p>Another cool feature is Soft Delete, which can be found in Data protection. There we can enable Soft delete for blobs. This feature enables us to recover blobs that were previously marked for deletion, including blobs that were overwritten. We can enable it for a specific time (in days), and some administrators can go back and restore the deleted blobs. This feature we enable if we really want to protect our data from accidental deletion at resource level or accidental deletion on API level.<\/p>\n<p>&nbsp;<\/p>\n<p>Also, there are some limitations, or things that we should consider before applying locks. For example, a cannot-delete lock on a storage account doesn&#8217;t prevent data within that account from being deleted or modified. This type of lock only protects the storage account itself from being deleted. If a request uses data plane operations, the lock on the storage account doesn&#8217;t protect the queue, table, or file data within that storage account. However, if the request uses control plane operations, the lock protects those resources. A read-only lock on a storage account doesn&#8217;t prevent data within that account from being deleted or modified. This type of lock only protects the storage account itself from being deleted or modified and doesn&#8217;t protect blob, queue, table, or file data within that storage account.<\/p>\n<p>&nbsp;<\/p>\n<p>It&#8217;s important to understand that locks don&#8217;t apply to all types of operations. Azure operations can be divided into two categories &#8211; control plane and data plane. Locks only apply to control plane operations. If you want to understand the resource locking in Azure Blueprints read this <a href=\"https:\/\/docs.microsoft.com\/en-us\/azure\/governance\/blueprints\/concepts\/resource-locking\">article.<\/a><\/p>\n<p>&nbsp;<\/p>\n<p>As an administrator, you can lock a subscription, resource group, or resource to prevent other users in your organization from accidentally deleting or modifying critical resources. The lock overrides any permissions the user might have.<\/p>\n<p>&nbsp;<\/p>\n<p>In this post, you can find also an <a href=\"https:\/\/mohamedradwan.com\/2021\/03\/08\/overview-for-some-azure-services-part-1\/\">Overview of some Azure\u00a0 Services (Part 1)<\/a><\/p>\n<p>&nbsp;<\/p>\n<p>Read more for Lock resources <a href=\"https:\/\/docs.microsoft.com\/en-us\/azure\/azure-resource-manager\/management\/lock-resources?tabs=json&amp;wt.mc_id=devops-42208-cxa\">here.<\/a><\/p>\n","protected":false},"excerpt":{"rendered":"<p>When we build Azure resources, it doesn\u2019t mean that someone &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"ast-button\" href=\"https:\/\/mohamedradwan.com\/2021\/09\/27\/preventing-resource-deletion-in-azure\/\"> <span class=\"screen-reader-text\">Preventing Resource Deletion in Azure<\/span> Read More<\/a><\/p>\n","protected":false},"author":1,"featured_media":10294,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-global-header-display":"","ast-banner-title-visibility":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","footnotes":""},"categories":[16,18],"tags":[99,1069],"_links":{"self":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/10271"}],"collection":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/comments?post=10271"}],"version-history":[{"count":5,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/10271\/revisions"}],"predecessor-version":[{"id":10582,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/posts\/10271\/revisions\/10582"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/media\/10294"}],"wp:attachment":[{"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/media?parent=10271"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/categories?post=10271"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/mohamedradwan.com\/wp-json\/wp\/v2\/tags?post=10271"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}